<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#1c1410">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<title>Tactic ‚Äî Chess Puzzles</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,500;0,700;1,500&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#1c1410;--bg2:#241a10;--bg3:#2e2216;--surface:#3a2c1c;--border:#5a4028;
  --gold:#c8973a;--gold-l:#e8b84b;--gold-d:#7a5418;
  --cream:#f0dfc0;--cream-d:#c8b090;--white:#f8f0e4;
  --red:#c0392b;--green:#27ae60;
  --light-sq:#f0d9b5;--dark-sq:#b58863;
  --light-hl:#cdd26a;--dark-hl:#aaa23a;
  --light-sel:#7fc97f;--dark-sel:#5a9e5a;
  --ff:'Playfair Display',Georgia,serif;
  --fm:'DM Mono',monospace;
  --fs:'DM Sans',system-ui,sans-serif;
  --r:8px;
}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--cream);font-family:var(--fs)}
.screen{position:fixed;inset:0;display:none;flex-direction:column;overflow-y:auto}
.screen.active{display:flex}

/* ‚îÄ‚îÄ WELCOME ‚îÄ‚îÄ */
#s-welcome{align-items:center;justify-content:center;background:radial-gradient(ellipse at 50% 30%,#3a2c1c,#1c1410 70%)}
.w-inner{text-align:center;padding:2rem;max-width:360px;width:100%}
.w-piece{font-size:5rem;margin-bottom:.75rem;filter:drop-shadow(0 4px 16px rgba(200,151,58,.45))}
.w-title{font-family:var(--ff);font-size:2.8rem;color:var(--gold-l);letter-spacing:-.02em;margin-bottom:.2rem}
.w-sub{color:var(--cream-d);font-size:.85rem;letter-spacing:.14em;text-transform:uppercase;margin-bottom:2.25rem}
.w-form input{width:100%;padding:.85rem 1rem;background:var(--surface);border:1px solid var(--border);border-radius:var(--r);color:var(--white);font-family:var(--fs);font-size:1rem;outline:none;margin-bottom:.65rem;transition:border-color .2s}
.w-form input:focus{border-color:var(--gold)}
.w-form input::placeholder{color:var(--cream-d);opacity:.45}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.35rem;padding:.75rem 1.4rem;border-radius:var(--r);border:none;cursor:pointer;font-family:var(--fs);font-size:.92rem;font-weight:500;transition:all .15s;text-decoration:none}
.btn-p{background:var(--gold);color:var(--bg)}.btn-p:hover{background:var(--gold-l);transform:translateY(-1px)}
.btn-g{background:transparent;border:1px solid var(--border);color:var(--cream-d)}.btn-g:hover{border-color:var(--gold);color:var(--gold)}
.btn-d{background:var(--red);color:#fff}.btn-d:hover{opacity:.85}
.btn-sm{padding:.4rem .8rem;font-size:.8rem}
.btn-full{width:100%}

/* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
#s-app{flex-direction:column}
.app-hdr{display:flex;align-items:center;justify-content:space-between;padding:.55rem 1rem;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0}
.hdr-logo{font-family:var(--ff);font-size:1.25rem;color:var(--gold)}
.hdr-right{display:flex;align-items:center;gap:.65rem}
.rating{font-family:var(--fm);font-size:.85rem;color:var(--gold-l)}
.streak{font-size:.82rem;color:#e67e22}
.avatar{width:26px;height:26px;border-radius:50%;background:var(--gold-d);display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:700;color:var(--cream)}
.tabs{display:flex;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0}
.tab{flex:1;padding:.6rem;text-align:center;font-size:.75rem;color:var(--cream-d);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;letter-spacing:.06em;text-transform:uppercase}
.tab.on{color:var(--gold);border-bottom-color:var(--gold)}
.tab-body{flex:1;overflow-y:auto;display:none;flex-direction:column}
.tab-body.on{display:flex}

/* ‚îÄ‚îÄ PUZZLE TAB ‚îÄ‚îÄ */
.filter-bar{padding:.55rem .85rem;display:flex;gap:.35rem;overflow-x:auto;flex-shrink:0;border-bottom:1px solid var(--border);background:var(--bg2);scrollbar-width:none}
.filter-bar::-webkit-scrollbar{display:none}
.chip{padding:.25rem .65rem;border-radius:20px;font-size:.72rem;border:1px solid var(--border);color:var(--cream-d);background:transparent;cursor:pointer;white-space:nowrap;transition:all .15s}
.chip.on{background:var(--gold-d);border-color:var(--gold);color:var(--gold-l)}
.pz-meta{padding:.5rem .9rem;display:flex;align-items:center;gap:.45rem;flex-wrap:wrap;background:var(--bg2);border-bottom:1px solid var(--border);flex-shrink:0;min-height:34px}
.tag{padding:.22rem .55rem;border-radius:20px;font-size:.7rem;font-weight:500;background:var(--surface);color:var(--cream-d);border:1px solid var(--border)}
.dbadge{padding:.22rem .55rem;border-radius:20px;font-size:.7rem;font-weight:600}
.d-easy{background:#1e4d2b;color:#5dba7d;border:1px solid #27ae60}
.d-medium{background:#4d3a0a;color:#e8b84b;border:1px solid #c8973a}
.d-hard{background:#4d1a14;color:#e87070;border:1px solid #c0392b}
.pz-prompt{padding:.5rem .9rem;font-size:.84rem;color:var(--cream-d);flex-shrink:0}
.pz-prompt strong{color:var(--cream)}
.pz-title{font-family:var(--ff);font-size:.92rem;color:var(--gold-l);margin-left:auto}

/* ‚îÄ‚îÄ BOARD ‚îÄ‚îÄ */
.board-wrap{display:flex;align-items:center;justify-content:center;padding:.55rem;flex-shrink:0}
.bc-grid{display:grid;grid-template-columns:14px 1fr;grid-template-rows:1fr 14px}
.c-ranks{display:flex;flex-direction:column;grid-column:1;grid-row:1}
.c-files{display:flex;grid-column:2;grid-row:2}
.c-cell{display:flex;align-items:center;justify-content:center;font-size:.55rem;font-family:var(--fm);color:var(--cream-d);opacity:.5}
#board{display:grid;grid-template-columns:repeat(8,1fr);grid-template-rows:repeat(8,1fr);width:min(88vw,410px);height:min(88vw,410px);border:3px solid #5a3a1a;border-radius:2px;box-shadow:0 8px 40px rgba(0,0,0,.75),inset 0 0 0 1px rgba(200,151,58,.08);user-select:none;touch-action:none}
.sq{position:relative;display:flex;align-items:center;justify-content:center;cursor:pointer}
.sq.lt{background:var(--light-sq)}.sq.dk{background:var(--dark-sq)}
.sq.hl.lt{background:var(--light-hl)}.sq.hl.dk{background:var(--dark-hl)}
.sq.sl.lt{background:var(--light-sel)}.sq.sl.dk{background:var(--dark-sel)}
.sq.lm.lt{background:#cdd26a}.sq.lm.dk{background:#aaa23a}
.sq.wf.lt{background:#e07070!important}.sq.wf.dk{background:#b03030!important}
.sq.cf.lt{background:#70c070!important}.sq.cf.dk{background:#409040!important}
.sq.hov{background:rgba(200,151,58,.28)!important}
.dot{width:28%;height:28%;border-radius:50%;background:rgba(0,0,0,.18);pointer-events:none;position:absolute}
.cring{width:87%;height:87%;border-radius:50%;border:4px solid rgba(0,0,0,.2);pointer-events:none;position:absolute}
.piece{width:87%;height:87%;display:flex;align-items:center;justify-content:center;font-size:calc(min(88vw,410px)/10);line-height:1;pointer-events:none;z-index:1;filter:drop-shadow(0 2px 3px rgba(0,0,0,.55))}
.piece.faded{opacity:.2}
.ghost{position:fixed;pointer-events:none;z-index:9999;font-size:calc(min(88vw,410px)/8.5);transform:translate(-50%,-50%);filter:drop-shadow(0 4px 10px rgba(0,0,0,.6));display:none}

/* ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ */
.pz-ctrl{padding:.6rem .9rem;display:flex;gap:.45rem;align-items:center;border-top:1px solid var(--border);flex-shrink:0;flex-wrap:wrap}
.fbk{font-size:.83rem;padding:.38rem .7rem;border-radius:var(--r);flex:1;min-width:120px}
.fbk.ok{background:#1e4d2b;color:#5dba7d;border:1px solid #27ae60}
.fbk.bad{background:#4d1a14;color:#e87070;border:1px solid #c0392b}
.fbk.info{background:var(--surface);color:var(--cream-d);border:1px solid var(--border)}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:1rem;color:var(--cream-d)}
.spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.load-text{font-size:.88rem;letter-spacing:.06em}

/* ‚îÄ‚îÄ PROGRESS TAB ‚îÄ‚îÄ */
.prog-body{padding:1rem;display:flex;flex-direction:column;gap:1rem}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:.65rem}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:.9rem;text-align:center}
.stat-v{font-family:var(--fm);font-size:1.75rem;color:var(--gold-l)}
.stat-l{font-size:.7rem;color:var(--cream-d);margin-top:.18rem;text-transform:uppercase;letter-spacing:.08em}
.sec-title{font-family:var(--ff);font-size:1.05rem;color:var(--gold);margin-bottom:.45rem}
.hist{display:flex;flex-direction:column;gap:.35rem}
.hist-item{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:.5rem .8rem;display:flex;justify-content:space-between;align-items:center;font-size:.8rem}
.hr-ok{background:#1e4d2b;color:#5dba7d;font-size:.7rem;padding:.16rem .42rem;border-radius:4px}
.hr-fail{background:#4d1a14;color:#e87070;font-size:.7rem;padding:.16rem .42rem;border-radius:4px}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:500;display:flex;align-items:center;justify-content:center;padding:1rem;opacity:0;pointer-events:none;transition:opacity .2s}
.overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:1.4rem;max-width:330px;width:100%;box-shadow:0 8px 40px rgba(0,0,0,.6)}
.modal h3{font-family:var(--ff);color:var(--gold-l);font-size:1.35rem;margin-bottom:.4rem}
.modal p{font-size:.88rem;color:var(--cream-d);margin-bottom:1.1rem;line-height:1.55}
.modal-btns{display:flex;gap:.45rem}

/* ‚îÄ‚îÄ EMPTY / ERROR ‚îÄ‚îÄ */
.empty{text-align:center;padding:2.5rem 1rem;color:var(--cream-d)}
.empty-ico{font-size:2.5rem;margin-bottom:.7rem;opacity:.3}
.empty p{font-size:.85rem;opacity:.5;line-height:1.6}
.empty code{font-family:var(--fm);font-size:.78rem;background:var(--surface);padding:.15rem .4rem;border-radius:4px;color:var(--gold-l)}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast{position:fixed;bottom:1.75rem;left:50%;transform:translateX(-50%) translateY(3rem);background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:.55rem 1.1rem;font-size:.85rem;color:var(--cream);z-index:1000;transition:transform .28s,opacity .28s;opacity:0;pointer-events:none;white-space:nowrap;box-shadow:0 4px 20px rgba(0,0,0,.5)}
#toast.show{transform:translateX(-50%) translateY(0);opacity:1}

/* ‚îÄ‚îÄ CONTRIBUTE BOX ‚îÄ‚îÄ */
.contribute{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);padding:.85rem 1rem;margin:.75rem;font-size:.8rem;color:var(--cream-d);line-height:1.6}
.contribute strong{color:var(--cream-d);display:block;margin-bottom:.3rem}
.contribute code{font-family:var(--fm);font-size:.75rem;background:var(--surface);padding:.1rem .35rem;border-radius:3px;color:var(--gold-l)}
</style>
</head>
<body>

<!-- WELCOME -->
<div id="s-welcome" class="screen active">
  <div class="w-inner">
    <div class="w-piece">‚ôü</div>
    <h1 class="w-title">Tactic</h1>
    <p class="w-sub">Club Tactics Trainer</p>
    <div class="w-form">
      <input type="text" id="nick-input" placeholder="Your nickname‚Ä¶" maxlength="24" autocomplete="off" spellcheck="false">
      <button class="btn btn-p btn-full" onclick="A.login()">Start Training</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="s-app" class="screen">
  <header class="app-hdr">
    <span class="hdr-logo">‚ôü Tactic</span>
    <div class="hdr-right">
      <span class="streak">üî•<span id="h-streak">0</span></span>
      <span class="rating" id="h-rating">1200</span>
      <div class="avatar" id="h-avatar">?</div>
    </div>
  </header>
  <div class="tabs">
    <div class="tab on" onclick="A.tab('puzzle')">Puzzles</div>
    <div class="tab" onclick="A.tab('progress')">Progress</div>
    <div class="tab" onclick="A.tab('info')">Info</div>
  </div>

  <!-- PUZZLE -->
  <div id="tb-puzzle" class="tab-body on">
    <div class="filter-bar" id="filter-bar">
      <div class="chip on" data-t="all" onclick="A.theme('all')">All</div>
      <div class="chip" data-t="Mate" onclick="A.theme('Mate')">Mate</div>
      <div class="chip" data-t="Fork" onclick="A.theme('Fork')">Fork</div>
      <div class="chip" data-t="Pin" onclick="A.theme('Pin')">Pin &amp; Skewer</div>
      <div class="chip" data-t="Discovery" onclick="A.theme('Discovery')">Discovery</div>
      <div class="chip" data-t="Endgame" onclick="A.theme('Endgame')">Endgame</div>
      <div class="chip" data-t="Opening" onclick="A.theme('Opening')">Opening Trap</div>
      <div class="chip" data-t="Zugzwang" onclick="A.theme('Zugzwang')">Zugzwang</div>
    </div>
    <div class="pz-meta" id="pz-meta">
      <span class="tag" id="m-theme">‚Äî</span>
      <span class="dbadge d-medium" id="m-diff">medium</span>
      <span class="pz-title" id="m-title"></span>
    </div>
    <div class="pz-prompt" id="pz-prompt"><strong>White</strong> to move</div>

    <!-- Loading state -->
    <div class="loading" id="loading-state">
      <div class="spinner"></div>
      <div class="load-text">Loading puzzles‚Ä¶</div>
    </div>

    <!-- Board (hidden while loading) -->
    <div id="board-area" style="display:none;flex-direction:column;flex:1">
      <div class="board-wrap">
        <div class="bc-grid">
          <div class="c-ranks" id="c-ranks"></div>
          <div id="board"></div>
          <div style="width:14px"></div>
          <div class="c-files" id="c-files"></div>
        </div>
      </div>
      <div class="pz-ctrl">
        <div class="fbk info" id="feedback">Find the best move</div>
        <button class="btn btn-g btn-sm" onclick="A.hint()">Hint</button>
        <button class="btn btn-g btn-sm" onclick="A.skip()">Skip</button>
        <button class="btn btn-g btn-sm" onclick="A.flipBoard()" title="Flip board">‚áÖ</button>
      </div>
    </div>

    <!-- Error / empty state -->
    <div class="empty" id="empty-state" style="display:none">
      <div class="empty-ico">‚ôü</div>
      <p id="empty-msg">No puzzles found.</p>
    </div>
  </div>

  <!-- PROGRESS -->
  <div id="tb-progress" class="tab-body">
    <div class="prog-body">
      <div class="stat-grid">
        <div class="stat-card"><div class="stat-v" id="s-rating">1200</div><div class="stat-l">Rating</div></div>
        <div class="stat-card"><div class="stat-v" id="s-solved">0</div><div class="stat-l">Solved</div></div>
        <div class="stat-card"><div class="stat-v" id="s-streak">0 üî•</div><div class="stat-l">Day Streak</div></div>
        <div class="stat-card"><div class="stat-v" id="s-acc">‚Äî</div><div class="stat-l">Accuracy</div></div>
      </div>
      <div class="stat-card" style="text-align:left">
        <div class="stat-l" style="margin-bottom:.3rem">Puzzle Pool</div>
        <div class="stat-v" id="s-total" style="font-size:1.1rem;color:var(--cream)">0 puzzles loaded</div>
        <div style="font-size:.75rem;color:var(--cream-d);margin-top:.2rem" id="s-files"></div>
      </div>
      <div>
        <div class="sec-title">Recent Activity</div>
        <div class="hist" id="hist-list"></div>
      </div>
    </div>
  </div>

  <!-- INFO -->
  <div id="tb-info" class="tab-body">
    <div class="prog-body">
      <div class="contribute">
        <strong>üìÇ How to add puzzles</strong>
        Puzzles live in the <code>/puzzles/</code> folder of the GitHub repo as PGN files. Add a new file and register it in <code>puzzles/index.json</code>.<br><br>
        <strong>Required PGN headers per game:</strong><br>
        <code>[SetupFen "..."]</code> ‚Äî the starting position<br>
        <code>[SetUp "1"]</code><br>
        <code>[Solution "e2e4 d7d5"]</code> ‚Äî UCI moves, space-separated<br>
        <code>[Theme "Fork"]</code> ‚Äî one of: Mate, Fork, Pin, Discovery, Endgame, Opening, Zugzwang<br>
        <code>[Difficulty "medium"]</code> ‚Äî easy / medium / hard<br>
        <code>[PuzzleTitle "My Puzzle"]</code> ‚Äî optional display name
      </div>
      <div class="contribute">
        <strong>üîÑ Workflow</strong>
        1. Create or edit a <code>.pgn</code> file in <code>/puzzles/</code><br>
        2. Add its filename to <code>puzzles/index.json</code><br>
        3. Commit &amp; push ‚Äî the app fetches fresh puzzles on each load<br><br>
        <strong>üíæ Your progress</strong>
        Ratings, streaks, and spaced repetition data are saved locally in your browser. Each club member has their own independent progress.
      </div>
      <div style="text-align:center;padding:1rem">
        <button class="btn btn-g btn-sm" onclick="A.logout()">‚Üê Switch User</button>
      </div>
    </div>
  </div>
</div>

<!-- SOLVED MODAL -->
<div class="overlay" id="modal">
  <div class="modal">
    <h3 id="modal-title">Puzzle Solved!</h3>
    <p id="modal-body"></p>
    <div class="modal-btns">
      <button class="btn btn-p" onclick="A.next()">Next ‚Üí</button>
      <button class="btn btn-g btn-sm" onclick="A.closeModal()">Review</button>
    </div>
  </div>
</div>

<div id="toast"></div>
<div id="ghost" class="ghost"></div>

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG ‚Äî update REPO_RAW to your GitHub raw base URL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const REPO_RAW = 'puzzles'; // relative path ‚Äî works on GitHub Pages from same repo
// If hosting elsewhere, set to e.g.:
// const REPO_RAW = 'https://raw.githubusercontent.com/YOUR_USER/YOUR_REPO/main';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PGN PARSER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parsePGN(text) {
  const puzzles = [];
  // Split on double-newline before a new [Event tag
  const games = text.split(/\n(?=\[Event\s)/);
  for (const game of games) {
    if (!game.trim()) continue;
    const headers = {};
    const headerRe = /\[(\w+)\s+"([^"]*)"\]/g;
    let m;
    while ((m = headerRe.exec(game)) !== null) {
      headers[m[1]] = m[2];
    }
    const fen = headers.SetupFen || headers.FEN;
    const solution = headers.Solution;
    if (!fen || !solution) continue; // skip games without required headers
    const moves = solution.trim().split(/\s+/).filter(Boolean);
    if (!moves.length) continue;

    // Determine side to move from FEN
    const fenParts = fen.split(' ');
    const side = fenParts[1] || 'w';

    puzzles.push({
      id: `${headers.White||'?'}-${headers.Black||'?'}-${fen.slice(0,12)}`,
      title: headers.PuzzleTitle || headers.White || 'Puzzle',
      fen,
      moves,
      side,
      theme: headers.Theme || 'Tactics',
      difficulty: (headers.Difficulty || 'medium').toLowerCase(),
      source: headers.Event || '',
    });
  }
  return puzzles;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHESS ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GLYPH = {'K':'‚ôî','Q':'‚ôï','R':'‚ôñ','B':'‚ôó','N':'‚ôò','P':'‚ôô','k':'‚ôö','q':'‚ôõ','r':'‚ôú','b':'‚ôù','n':'‚ôû','p':'‚ôü'};
const FILES = 'abcdefgh';
const isW = p => p && p === p.toUpperCase() && p !== p.toLowerCase();
const isB = p => p && p === p.toLowerCase() && p !== p.toUpperCase();
const inB = (f,r) => f >= 0 && f < 8 && r >= 1 && r <= 8;

function parseFen(fen) {
  const [pos, turn, cast, ep] = fen.trim().split(' ');
  const board = {};
  pos.split('/').forEach((row, ri) => {
    let fi = 0;
    for (const ch of row) {
      if (/\d/.test(ch)) fi += +ch;
      else { board[FILES[fi] + (8 - ri)] = ch; fi++; }
    }
  });
  return { board, turn: turn || 'w', castling: cast || '-', ep: ep || '-' };
}

function applyMove(st, { from, to, promo }) {
  const s = { board: { ...st.board }, turn: st.turn, castling: st.castling, ep: st.ep };
  const piece = s.board[from];
  if (!piece) return s;
  // En passant capture
  if (piece.toLowerCase() === 'p' && to === s.ep) {
    const epr = st.turn === 'w' ? +to[1] - 1 : +to[1] + 1;
    delete s.board[to[0] + epr];
  }
  // Castling rook moves
  const castleMoves = {K:{from:'e1',to:'g1',rf:'h1',rt:'f1'},Q:{from:'e1',to:'c1',rf:'a1',rt:'d1'},k:{from:'e8',to:'g8',rf:'h8',rt:'f8'},q:{from:'e8',to:'c8',rf:'a8',rt:'d8'}};
  for (const [type, cm] of Object.entries(castleMoves)) {
    if (from === cm.from && to === cm.to && s.board[from] === (isW(piece) ? 'K' : 'k')) {
      s.board[cm.rt] = s.board[cm.rf]; delete s.board[cm.rf]; break;
    }
  }
  // Update castling rights
  const castleUpdates = {e1:['K','Q'],e8:['k','q'],a1:['Q'],h1:['K'],a8:['q'],h8:['k']};
  for (const sq of [from, to]) {
    (castleUpdates[sq] || []).forEach(c => { s.castling = s.castling.replace(c, ''); });
  }
  if (!s.castling) s.castling = '-';
  // En passant flag
  if (piece.toLowerCase() === 'p' && Math.abs(+to[1] - +from[1]) === 2)
    s.ep = from[0] + (st.turn === 'w' ? +from[1] + 1 : +from[1] - 1);
  else s.ep = '-';
  s.board[to] = promo ? (st.turn === 'w' ? promo.toUpperCase() : promo.toLowerCase()) : piece;
  delete s.board[from];
  s.turn = st.turn === 'w' ? 'b' : 'w';
  return s;
}

function isAttacked(st, sq, byColor) {
  const b = st.board, fi = FILES.indexOf(sq[0]), ri = +sq[1];
  const pawn = byColor === 'w' ? 'P' : 'p';
  const pDir = byColor === 'w' ? -1 : 1;
  for (const df of [-1, 1]) { const f2 = fi + df, r2 = ri + pDir; if (inB(f2, r2) && b[FILES[f2] + r2] === pawn) return true; }
  const knight = byColor === 'w' ? 'N' : 'n';
  for (const [df, dr] of [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]]) {
    const f2 = fi+df, r2 = ri+dr; if (inB(f2,r2) && b[FILES[f2]+r2] === knight) return true;
  }
  const rook = byColor === 'w' ? 'R' : 'r', queen = byColor === 'w' ? 'Q' : 'q';
  for (const [df,dr] of [[1,0],[-1,0],[0,1],[0,-1]]) {
    let f2=fi+df, r2=ri+dr;
    while (inB(f2,r2)) { const p=b[FILES[f2]+r2]; if (p) { if (p===rook||p===queen) return true; break; } f2+=df; r2+=dr; }
  }
  const bishop = byColor === 'w' ? 'B' : 'b';
  for (const [df,dr] of [[1,1],[1,-1],[-1,1],[-1,-1]]) {
    let f2=fi+df, r2=ri+dr;
    while (inB(f2,r2)) { const p=b[FILES[f2]+r2]; if (p) { if (p===bishop||p===queen) return true; break; } f2+=df; r2+=dr; }
  }
  const king = byColor === 'w' ? 'K' : 'k';
  for (const [df,dr] of [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]]) {
    const f2=fi+df, r2=ri+dr; if (inB(f2,r2) && b[FILES[f2]+r2] === king) return true;
  }
  return false;
}

function inCheck(st, color) {
  const king = color === 'w' ? 'K' : 'k';
  for (const sq in st.board) if (st.board[sq] === king) return isAttacked(st, sq, color === 'w' ? 'b' : 'w');
  return false;
}

function pseudoMoves(st, from, piece, color) {
  const b = st.board, fi = FILES.indexOf(from[0]), ri = +from[1];
  const moves = [];
  const friendly = color === 'w' ? isW : isB, enemy = color === 'w' ? isB : isW;
  const slide = dirs => { for (const [df,dr] of dirs) { let f2=fi+df,r2=ri+dr; while(inB(f2,r2)){const t=b[FILES[f2]+r2];if(t){if(enemy(t))moves.push(FILES[f2]+r2);break;}moves.push(FILES[f2]+r2);f2+=df;r2+=dr;}}};
  const pt = piece.toLowerCase();
  if (pt === 'p') {
    const dir = color==='w'?1:-1, start = color==='w'?2:7;
    if (inB(fi,ri+dir)&&!b[FILES[fi]+(ri+dir)]) { moves.push(FILES[fi]+(ri+dir)); if(ri===start&&!b[FILES[fi]+(ri+2*dir)])moves.push(FILES[fi]+(ri+2*dir)); }
    for (const df of [-1,1]) { if(!inB(fi+df,ri+dir))continue; const ts=FILES[fi+df]+(ri+dir); if(enemy(b[ts])||ts===st.ep)moves.push(ts); }
  }
  if (pt === 'n') for (const [df,dr] of [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]]) { const f2=fi+df,r2=ri+dr; if(inB(f2,r2)&&!friendly(b[FILES[f2]+r2]))moves.push(FILES[f2]+r2); }
  if (pt === 'b') slide([[1,1],[1,-1],[-1,1],[-1,-1]]);
  if (pt === 'r') slide([[1,0],[-1,0],[0,1],[0,-1]]);
  if (pt === 'q') slide([[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]]);
  if (pt === 'k') {
    for (const [df,dr] of [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]]) { const f2=fi+df,r2=ri+dr; if(inB(f2,r2)&&!friendly(b[FILES[f2]+r2]))moves.push(FILES[f2]+r2); }
    if (color==='w'&&from==='e1') {
      if(st.castling.includes('K')&&!b.f1&&!b.g1&&!isAttacked(st,'e1','b')&&!isAttacked(st,'f1','b')&&!isAttacked(st,'g1','b'))moves.push('g1');
      if(st.castling.includes('Q')&&!b.d1&&!b.c1&&!b.b1&&!isAttacked(st,'e1','b')&&!isAttacked(st,'d1','b')&&!isAttacked(st,'c1','b'))moves.push('c1');
    }
    if (color==='b'&&from==='e8') {
      if(st.castling.includes('k')&&!b.f8&&!b.g8&&!isAttacked(st,'e8','w')&&!isAttacked(st,'f8','w')&&!isAttacked(st,'g8','w'))moves.push('g8');
      if(st.castling.includes('q')&&!b.d8&&!b.c8&&!b.b8&&!isAttacked(st,'e8','w')&&!isAttacked(st,'d8','w')&&!isAttacked(st,'c8','w'))moves.push('c8');
    }
  }
  return moves;
}

function legalMoves(st, from) {
  const piece = st.board[from]; if (!piece) return [];
  const color = isW(piece) ? 'w' : 'b';
  return pseudoMoves(st, from, piece, color).filter(to => !inCheck(applyMove(st, {from, to, promo:null}), color));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ELO + SPACED REPETITION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function eloUpdate(ra, rb, score, k=32) { return Math.round(ra + k * (score - 1/(1+Math.pow(10,(rb-ra)/400)))); }
function srSchedule(rec, ok) {
  const now = Date.now();
  if (!rec) rec = {interval:1, ease:2.5, due:now, reps:0};
  if (ok) { rec.reps++; rec.interval = rec.reps===1?1:rec.reps===2?6:Math.round(rec.interval*rec.ease); rec.ease = Math.max(1.3, rec.ease+0.1); }
  else { rec.reps=0; rec.interval=1; rec.ease = Math.max(1.3, rec.ease-0.2); }
  rec.due = now + rec.interval * 86400000;
  return rec;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DB = {
  get: (k,d=null) => { try { const v=localStorage.getItem(k); return v!==null?JSON.parse(v):d; } catch { return d; } },
  set: (k,v) => { try { localStorage.setItem(k,JSON.stringify(v)); } catch {} }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const A = (() => {
  let user = null;
  let allPuzzles = []; // loaded from PGN files
  let loadedFiles = [];
  let cur = null, state = null;
  let solMoves = [], solIdx = 0, isDone = false;
  let selSq = null, legalTgts = [], lastMove = null;
  let flipped = false, themeFilter = 'all';
  let dragFrom = null, dragPiece = null;

  // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
  async function init() {
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(() => {});
    const saved = DB.get('currentUser');
    if (saved) { user = saved; await enterApp(); }
    else showScreen('welcome');
  }

  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('s-' + id).classList.add('active');
  }

  async function login() {
    const nick = document.getElementById('nick-input').value.trim();
    if (!nick) { toast('Enter a nickname'); return; }
    const users = DB.get('users', {});
    if (!users[nick]) users[nick] = { nick, rating:1200, solved:0, failed:0, streak:0, lastDay:null, history:[], sr:{} };
    DB.set('users', users);
    user = users[nick];
    DB.set('currentUser', user);
    await enterApp();
  }

  async function enterApp() {
    showScreen('app');
    renderHeader();
    await loadPuzzles();
  }

  function logout() {
    DB.set('currentUser', null);
    user = null;
    showScreen('welcome');
  }

  // ‚îÄ‚îÄ LOAD PUZZLES FROM REPO ‚îÄ‚îÄ
  async function loadPuzzles() {
    showLoading(true);
    try {
      // 1. Fetch the index file
      const idxResp = await fetch(`${REPO_RAW}/index.json`, { cache: 'no-cache' });
      if (!idxResp.ok) throw new Error(`Cannot load puzzles/index.json (${idxResp.status})`);
      const idx = await idxResp.json();
      const files = idx.files || [];
      if (!files.length) throw new Error('puzzles/index.json lists no files');

      // 2. Fetch each PGN file
      allPuzzles = [];
      loadedFiles = [];
      const results = await Promise.allSettled(files.map(f => fetch(`${REPO_RAW}/${f}`, { cache: 'no-cache' })));
      for (let i = 0; i < results.length; i++) {
        const res = results[i];
        if (res.status === 'rejected' || !res.value.ok) {
          console.warn(`Failed to fetch ${files[i]}`);
          continue;
        }
        const text = await res.value.text();
        const parsed = parsePGN(text);
        allPuzzles.push(...parsed);
        loadedFiles.push(`${files[i]} (${parsed.length})`);
      }

      if (!allPuzzles.length) throw new Error('No valid puzzles found in PGN files. Check that your PGN includes [SetupFen], [Solution], and [SetUp "1"] headers.');

      showLoading(false);
      showBoard(true);
      updatePoolStats();
      loadNextPuzzle();
    } catch (err) {
      showLoading(false);
      showEmpty(err.message);
    }
  }

  function showLoading(on) {
    document.getElementById('loading-state').style.display = on ? 'flex' : 'none';
    document.getElementById('board-area').style.display = on ? 'none' : 'flex';
    document.getElementById('empty-state').style.display = 'none';
  }

  function showBoard(on) {
    document.getElementById('board-area').style.display = on ? 'flex' : 'none';
    document.getElementById('empty-state').style.display = 'none';
  }

  function showEmpty(msg) {
    document.getElementById('empty-state').style.display = '';
    document.getElementById('empty-msg').innerHTML = msg.replace(/`([^`]+)`/g, '<code>$1</code>');
    document.getElementById('board-area').style.display = 'none';
  }

  function updatePoolStats() {
    document.getElementById('s-total').textContent = `${allPuzzles.length} puzzle${allPuzzles.length!==1?'s':''} loaded`;
    document.getElementById('s-files').textContent = loadedFiles.join(' ¬∑ ');
  }

  // ‚îÄ‚îÄ PUZZLE SELECTION (SR + theme filter) ‚îÄ‚îÄ
  function eligible() {
    const now = Date.now();
    const sr = user.sr || {};
    let pool = allPuzzles.filter(p => {
      if (themeFilter !== 'all' && p.theme !== themeFilter) return false;
      const rec = sr[p.id];
      if (!rec) return true; // never seen
      return rec.due <= now + 3600000;
    });
    // Fallback: if everything is reviewed, show all in theme
    if (!pool.length) pool = allPuzzles.filter(p => themeFilter === 'all' || p.theme === themeFilter);
    if (!pool.length) pool = [...allPuzzles];
    // Sort: most overdue first
    pool.sort((a, b) => (sr[a.id]?.due || 0) - (sr[b.id]?.due || 0));
    return pool;
  }

  function loadNextPuzzle() {
    const pool = eligible();
    if (!pool.length) { showEmpty('No puzzles match this filter.'); return; }
    const p = pool.find(px => !cur || px.id !== cur.id) || pool[0];
    loadPuzzle(p);
  }

  function loadPuzzle(p) {
    cur = p; solMoves = [...p.moves]; solIdx = 0; isDone = false;
    selSq = null; legalTgts = []; lastMove = null; flipped = p.side === 'b';
    state = parseFen(p.fen);

    document.getElementById('m-theme').textContent = p.theme || '‚Äî';
    const db = document.getElementById('m-diff'); db.textContent = p.difficulty; db.className = 'dbadge d-' + p.difficulty;
    document.getElementById('m-title').textContent = p.title || '';
    document.getElementById('pz-prompt').innerHTML = `<strong>${p.side === 'w' ? 'White' : 'Black'}</strong> to move`;
    document.getElementById('modal').classList.remove('open');

    showBoard(true);
    renderBoard();
    setFeedback('Find the best move', 'info');
  }

  // ‚îÄ‚îÄ BOARD RENDER ‚îÄ‚îÄ
  function renderBoard() {
    const el = document.getElementById('board');
    el.innerHTML = '';
    const ranks = flipped ? [1,2,3,4,5,6,7,8] : [8,7,6,5,4,3,2,1];
    const files = flipped ? ['h','g','f','e','d','c','b','a'] : ['a','b','c','d','e','f','g','h'];

    document.getElementById('c-ranks').innerHTML = ranks.map(r => `<div class="c-cell" style="flex:1">${r}</div>`).join('');
    document.getElementById('c-files').innerHTML = files.map(f => `<div class="c-cell" style="flex:1">${f}</div>`).join('');

    for (const rank of ranks) {
      for (const file of files) {
        const sqn = file + rank;
        const light = (FILES.indexOf(file) + rank) % 2 === 0;
        const div = document.createElement('div');
        div.className = 'sq ' + (light ? 'lt' : 'dk');
        div.dataset.sq = sqn;

        if (lastMove && (sqn === lastMove.from || sqn === lastMove.to)) div.classList.add('lm');
        if (selSq === sqn) div.classList.add('sl');
        if (legalTgts.includes(sqn)) {
          const m = document.createElement('div');
          m.className = state.board[sqn] ? 'cring' : 'dot';
          div.appendChild(m);
        }
        const piece = state.board[sqn];
        if (piece) {
          const pe = document.createElement('div');
          pe.className = 'piece';
          pe.textContent = GLYPH[piece];
          div.appendChild(pe);
        }

        div.addEventListener('click', () => onSqClick(sqn));
        div.addEventListener('mousedown', e => { if (e.button === 0) startDrag(sqn, e.clientX, e.clientY); });
        div.addEventListener('touchstart', e => { e.preventDefault(); const t = e.touches[0]; startDrag(sqn, t.clientX, t.clientY); }, { passive: false });
        el.appendChild(div);
      }
    }

    el.onmousemove = e => { if (dragPiece) { moveGhost(e.clientX, e.clientY); hoverSq(e.clientX, e.clientY); } };
    el.ontouchmove = e => { if (dragPiece) { e.preventDefault(); const t = e.touches[0]; moveGhost(t.clientX, t.clientY); hoverSq(t.clientX, t.clientY); } };
    el.onmouseup = e => { if (dragPiece) endDrag(document.elementFromPoint(e.clientX, e.clientY)?.closest('[data-sq]')?.dataset?.sq); };
    el.ontouchend = e => { if (dragPiece) { const t = e.changedTouches[0]; endDrag(document.elementFromPoint(t.clientX, t.clientY)?.closest('[data-sq]')?.dataset?.sq); } };
  }

  function isPlayerPiece(p) { return cur ? (cur.side === 'w' ? isW(p) : isB(p)) : false; }

  // ‚îÄ‚îÄ INTERACTION ‚îÄ‚îÄ
  function onSqClick(sqn) {
    if (isDone || dragPiece) return;
    if (selSq === sqn) { selSq = null; legalTgts = []; renderBoard(); return; }
    if (selSq && legalTgts.includes(sqn)) { doMove(selSq, sqn); return; }
    const p = state.board[sqn];
    if (p && isPlayerPiece(p)) { selSq = sqn; legalTgts = legalMoves(state, sqn); renderBoard(); }
    else { selSq = null; legalTgts = []; renderBoard(); }
  }

  function startDrag(sqn, x, y) {
    const p = state.board[sqn]; if (!p || !isPlayerPiece(p) || isDone) return;
    dragFrom = sqn; dragPiece = p; selSq = sqn; legalTgts = legalMoves(state, sqn); renderBoard();
    const g = document.getElementById('ghost'); g.textContent = GLYPH[p]; g.style.display = 'block'; g.style.left = x+'px'; g.style.top = y+'px';
    document.querySelector(`[data-sq="${sqn}"] .piece`)?.classList.add('faded');
  }
  function moveGhost(x, y) { const g = document.getElementById('ghost'); g.style.left = x+'px'; g.style.top = y+'px'; }
  function hoverSq(x, y) {
    document.querySelectorAll('.sq.hov').forEach(e => e.classList.remove('hov'));
    const el = document.elementFromPoint(x, y)?.closest('[data-sq]');
    if (el && legalTgts.includes(el.dataset.sq)) el.classList.add('hov');
  }
  function endDrag(toSq) {
    document.getElementById('ghost').style.display = 'none';
    document.querySelectorAll('.sq.hov').forEach(e => e.classList.remove('hov'));
    const from = dragFrom; dragPiece = null; dragFrom = null;
    if (toSq && toSq !== from && legalTgts.includes(toSq)) { selSq = null; legalTgts = []; doMove(from, toSq); }
    else { selSq = null; legalTgts = []; renderBoard(); }
  }

  // ‚îÄ‚îÄ MOVE LOGIC ‚îÄ‚îÄ
  function doMove(from, to) {
    const exp = solMoves[solIdx];
    const piece = state.board[from];
    let promo = null;
    if (piece?.toLowerCase() === 'p') { const r = +to[1]; if ((isW(piece) && r===8)||(isB(piece) && r===1)) promo = exp?.[4] || 'q'; }
    const uci = from + to + (promo || '');
    const expBase = exp?.slice(0, 4);

    if (uci === exp || from+to === expBase) {
      // ‚úì Correct
      lastMove = { from, to }; state = applyMove(state, { from, to, promo }); solIdx++;
      selSq = null; legalTgts = []; renderBoard(); flash([from, to], 'cf');

      if (solIdx >= solMoves.length) {
        setTimeout(() => complete(true), 380);
      } else {
        setFeedback('‚úì Correct! Keep going‚Ä¶', 'ok');
        setTimeout(() => {
          // Opponent's response
          const mv = solMoves[solIdx]; const mf = mv.slice(0,2), mt = mv.slice(2,4), mp = mv[4]||null;
          lastMove = { from:mf, to:mt }; state = applyMove(state, {from:mf, to:mt, promo:mp}); solIdx++;
          selSq = null; legalTgts = []; renderBoard();
          if (solIdx >= solMoves.length) setTimeout(() => complete(true), 380);
          else setFeedback('Find the next move', 'info');
        }, 620);
      }
    } else {
      // ‚úó Wrong ‚Äî retry
      flash([from, to], 'wf');
      setFeedback('‚úó Not the right move ‚Äî try again', 'bad');
      selSq = null; legalTgts = []; renderBoard();
    }
  }

  function flash(sqs, cls) {
    sqs.forEach(s => { const el = document.querySelector(`[data-sq="${s}"]`); if (el) { el.classList.add(cls); setTimeout(() => el.classList.remove(cls), 480); } });
  }

  function complete(success) {
    isDone = true;
    // Streak
    const today = new Date().toDateString();
    if (user.lastDay !== today) {
      const yest = new Date(Date.now()-86400000).toDateString();
      user.streak = user.lastDay === yest ? (user.streak||0)+1 : 1;
      user.lastDay = today;
    }
    // Rating
    const pRating = { easy:1000, medium:1400, hard:1800 }[cur.difficulty] || 1400;
    const prevRating = user.rating;
    if (success) { user.rating = eloUpdate(user.rating, pRating, 1); user.solved = (user.solved||0)+1; }
    else { user.rating = eloUpdate(user.rating, pRating, 0); user.failed = (user.failed||0)+1; }
    user.rating = Math.max(400, user.rating);
    // SR
    if (!user.sr) user.sr = {};
    user.sr[cur.id] = srSchedule(user.sr[cur.id], success);
    // History
    if (!user.history) user.history = [];
    user.history.push({ name: cur.title, success, ts: Date.now(), ratingAfter: user.rating });
    if (user.history.length > 150) user.history.shift();
    // Persist
    const users = DB.get('users', {}); users[user.nick] = user; DB.set('users', users); DB.set('currentUser', user);
    renderHeader();
    const diff = user.rating - prevRating;
    const diffStr = diff >= 0 ? `+${diff}` : `${diff}`;
    document.getElementById('modal-title').textContent = success ? 'üéâ Puzzle Solved!' : 'üí° Solution Shown';
    document.getElementById('modal-body').textContent = success
      ? `Great find! Rating: ${user.rating} (${diffStr})`
      : `Tough one. Rating: ${user.rating} (${diffStr}). Review the solution and press Next.`;
    document.getElementById('modal').classList.add('open');
  }

  // ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ
  function hint() {
    if (!cur || isDone) return;
    const from = solMoves[solIdx]?.slice(0, 2); if (!from) return;
    selSq = from; legalTgts = legalMoves(state, from); renderBoard();
    setFeedback(`Hint: piece on ${from.toUpperCase()}`, 'info');
  }

  function skip() {
    if (!cur) return;
    // Play remaining moves
    for (let i = solIdx; i < solMoves.length; i++) {
      const mv = solMoves[i]; const mf=mv.slice(0,2),mt=mv.slice(2,4),mp=mv[4]||null;
      lastMove={from:mf,to:mt}; state=applyMove(state,{from:mf,to:mt,promo:mp});
    }
    solIdx = solMoves.length; renderBoard(); complete(false);
  }

  function flipBoard() { flipped = !flipped; renderBoard(); }
  function next() { closeModal(); loadNextPuzzle(); }
  function closeModal() { document.getElementById('modal').classList.remove('open'); }

  function theme(t) {
    themeFilter = t;
    document.querySelectorAll('.chip').forEach(el => el.classList.toggle('on', el.dataset.t === t));
    if (allPuzzles.length) loadNextPuzzle();
  }

  function tab(name) {
    document.querySelectorAll('.tab').forEach((el,i)=>el.classList.toggle('on',['puzzle','progress','info'][i]===name));
    document.querySelectorAll('.tab-body').forEach(el=>el.classList.toggle('on',el.id==='tb-'+name));
    if (name==='progress') renderProgress();
  }

  // ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ
  function renderHeader() {
    document.getElementById('h-rating').textContent = user.rating;
    document.getElementById('h-avatar').textContent = user.nick[0].toUpperCase();
    document.getElementById('h-streak').textContent = user.streak;
    document.getElementById('s-rating').textContent = user.rating;
    document.getElementById('s-solved').textContent = user.solved || 0;
    document.getElementById('s-streak').textContent = (user.streak||0) + ' üî•';
    const tot = (user.solved||0) + (user.failed||0);
    document.getElementById('s-acc').textContent = tot ? Math.round((user.solved||0)/tot*100)+'%' : '‚Äî';
  }

  function renderProgress() {
    renderHeader();
    updatePoolStats();
    const hist = user.history || [];
    const el = document.getElementById('hist-list');
    if (!hist.length) { el.innerHTML = '<div class="empty" style="padding:1rem 0"><div class="empty-ico">üìã</div><p>No activity yet</p></div>'; return; }
    el.innerHTML = [...hist].reverse().slice(0, 30).map(h =>
      `<div class="hist-item"><span>${h.name||'Puzzle'}</span><span class="${h.success?'hr-ok':'hr-fail'}">${h.success?'‚úì Solved':'‚úó Skipped'}</span></div>`
    ).join('');
  }

  function setFeedback(msg, type) { const el=document.getElementById('feedback'); el.textContent=msg; el.className='fbk '+type; }

  let toastTmr;
  function toast(msg) { const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); clearTimeout(toastTmr); toastTmr=setTimeout(()=>el.classList.remove('show'),2500); }

  return { init, login, logout, tab, theme, hint, skip, flipBoard, next, closeModal };
})();

document.addEventListener('DOMContentLoaded', A.init);
document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.activeElement === document.getElementById('nick-input')) A.login();
});
</script>
</body>
</html>
